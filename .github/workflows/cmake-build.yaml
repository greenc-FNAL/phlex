name: CMake Build and Test
run-name: "${{ github.actor }} building and testing ${{ github.repository }}"

on:
  pull_request:
    branches: [ main, develop ]
  issue_comment:
    types: [created]
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      build-combinations:
        description: |
          A space- or comma-separated list of build combinations to run.
          Syntax examples:
          - `gcc/asan clang/tsan` (run only these two)
          - `all` (run all combinations)
          - `all -clang/none -clang/valgrind` (run all except specified)
          - `+clang/none +clang/valgrind` (run default matrix plus specified)
          Default (if empty): Run all except clang/none and clang/valgrind.
        required: false
        default: ''
  workflow_call:
    inputs:
      checkout-path:
        description: "Path to check out code to"
        required: false
        type: string
      build-path:
        description: "Path for build artifacts"
        required: false
        type: string
      skip-relevance-check:
        description: "Bypass relevance check"
        required: false
        type: boolean
        default: false
      build-combinations:
        description: "A space- or comma-separated list of build combinations to run"
        required: false
        type: string
      ref:
        description: "The branch or ref to checkout"
        required: false
        type: string
      repo:
        description: "The repository to checkout from"
        required: false
        type: string
      pr-base-sha:
        description: "Base SHA of the PR for relevance check"
        required: false
        type: string
      pr-head-sha:
        description: "Head SHA of the PR for relevance check"
        required: false
        type: string

permissions:
  contents: read
  pull-requests: read

env:
  BUILD_TYPE: Release
  CICOLOR_FORCE: 1
  local-checkout-path: ${{ (github.event_name == 'workflow_call' && inputs.checkout-path) || format('{0}-src', github.event.repository.name) }}
  local-build-path: ${{ (github.event_name == 'workflow_call' && inputs.build-path) || format('{0}-build', github.event.repository.name) }}

jobs:
  pre-check:
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_call' ||
      (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        (github.event.comment.author_association == 'COLLABORATOR' || github.event.comment.author_association == 'OWNER') &&
        (
          startsWith(github.event.comment.body, '@phlexbot build') ||
          startsWith(github.event.comment.body, format('@{0}bot build', github.event.repository.name))
        )
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    outputs:
      is_act: ${{ steps.detect_act.outputs.is_act }}
      sha: ${{ (github.event_name == 'workflow_call' && inputs.ref) || steps.pr.outputs.sha || github.sha }}
      repo: ${{ (github.event_name == 'workflow_call' && inputs.repo) || steps.pr.outputs.repo || github.repository }}

    steps:
      - name: Get PR details for comment trigger
        if: github.event_name == 'issue_comment'
        id: pr
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              ref: pr.data.head.ref,
              sha: pr.data.head.sha,
              repo: pr.data.head.repo.full_name,
              base_sha: pr.data.base.sha
            };

      - name: Detect act environment
        id: detect_act
        uses: Framework-R-D/phlex/.github/actions/detect-act-env@main

  detect-changes:
    needs: pre-check
    if: >
      needs.pre-check.result == 'success' &&
      (
        github.event_name == 'pull_request' ||
        github.event_name == 'push' ||
        (github.event_name == 'workflow_call' && inputs.skip-relevance-check != 'true')
      ) &&
      needs.pre-check.outputs.is_act != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_changes: ${{ steps.filter.outputs.matched }}

    steps:
      - name: Check out source code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          path: ${{ env.local-checkout-path }}

      - name: Detect C++ and CMake changes
        id: filter
        uses: Framework-R-D/phlex/.github/actions/detect-relevant-changes@main
        with:
          repo-path: ${{ env.local-checkout-path }}
          base-ref: ${{ (github.event_name == 'workflow_call' && inputs.pr-base-sha) || github.event.pull_request.base.sha || github.event.before }}
          head-ref: ${{ (github.event_name == 'workflow_call' && inputs.pr-head-sha) || github.event.pull_request.head.sha || github.sha }}
          file-type: |
            cpp
            cmake

      - name: Report detection outcome
        run: |
          if [ "${{ steps.filter.outputs.matched }}" != "true" ]; then
            echo "::notice::No C++ or CMake changes detected; build will be skipped."
          else
            echo "::group::C++ and CMake relevant files"
            printf '%s\n' "${{ steps.filter.outputs.matched_files }}"
            echo "::endgroup::"
          fi

  generate-matrix:
    needs: pre-check
    if: needs.pre-check.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - id: generate
        uses: Framework-R-D/phlex/.github/actions/generate-build-matrix@main
        with:
          user-input: ${{ (github.event_name == 'workflow_call' && inputs.build-combinations) || github.event.inputs.build-combinations }}
          comment-body: ${{ github.event.comment.body }}

  build:
    needs: [pre-check, detect-changes, generate-matrix]
    if: >
      needs.pre-check.result == 'success' &&
      (
        github.event_name == 'workflow_dispatch' ||
        github.event_name == 'issue_comment' ||
        (github.event_name == 'workflow_call' && inputs.skip-relevance-check == 'true') ||
        needs.pre-check.outputs.is_act == 'true' ||
        (needs.detect-changes.result == 'success' && needs.detect-changes.outputs.has_changes == 'true')
      )
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.generate-matrix.outputs.matrix) }}

    container:
      image: ghcr.io/framework-r-d/phlex-ci:latest

    steps:
    - name: Check out code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        path: ${{ env.local-checkout-path }}
        ref: ${{ needs.pre-check.outputs.sha }}
        repository: ${{ needs.pre-check.outputs.repo }}

    - name: Setup build environment
      uses: Framework-R-D/phlex/.github/actions/setup-build-env@main
      with:
        build-path: ${{ env.local-build-path }}

    - name: Announce CMake configuration
      run: echo "➡️ Configuring CMake..."

    - name: Extract repository name
      id: repo_name
      run: echo "name=$(echo '${{ needs.pre-check.outputs.repo }}' | sed 's:.*/::')" >> $GITHUB_OUTPUT

    - name: Configure CMake
      id: configure
      uses: Framework-R-D/phlex/.github/actions/configure-cmake@main
      with:
        source-path: ${{ env.local-checkout-path }}
        build-path: ${{ env.local-build-path }}
        build-type: ${{ env.BUILD_TYPE }}
        cpp-compiler: ${{ matrix.compiler == 'gcc' && 'g++' || 'clang++' }}
        extra-options: |
          ${{ matrix.sanitizer == 'asan' && format('-D{0}_ENABLE_ASAN=ON', steps.repo_name.outputs.name) || '' }}
          ${{ matrix.sanitizer == 'tsan' && format('-D{0}_ENABLE_TSAN=ON', steps.repo_name.outputs.name) || '' }}

    - name: Build
      id: build
      uses: Framework-R-D/phlex/.github/actions/build-cmake@main
      with:
        build-path: ${{ env.local-build-path }}

    - name: Run tests
      if: matrix.sanitizer != 'valgrind'
      run: |
        . /entrypoint.sh
        cd "$GITHUB_WORKSPACE/${{ env.local-build-path }}"

        echo "➡️ Running tests..."
        echo "::group::Running ctest"
        if ctest --progress --output-on-failure -j "$(nproc)"; then
          echo "::endgroup::"
          echo "✅ All tests passed."
        else
          echo "::endgroup::"
          echo "::error:: Some tests failed."
          exit 1
        fi

    - name: Run Valgrind tests
      if: matrix.sanitizer == 'valgrind'
      run: |
        . /entrypoint.sh
        cd "$GITHUB_WORKSPACE/${{ env.local-build-path }}"

        echo "➡️ Running Valgrind tests..."
        echo "::group::Running ctest -T memcheck"
        if ctest -T memcheck; then
          echo "::endgroup::"
          echo "✅ Valgrind tests passed."
        else
          echo "::endgroup::"
          echo "⚠️ Valgrind tests failed, but the workflow will continue."
        fi

  cmake-build-skipped:
    needs: [pre-check, detect-changes]
    if: >
      needs.pre-check.result == 'success' &&
      github.event_name != 'workflow_dispatch' &&
      (github.event_name != 'workflow_call' || inputs.skip-relevance-check != 'true') &&
      needs.pre-check.outputs.is_act != 'true' &&
      (needs.detect-changes.result == 'success' && needs.detect-changes.outputs.has_changes != 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: No relevant C++ or CMake changes detected
      run: echo "::notice::No relevant C++ or CMake changes detected; build skipped."
