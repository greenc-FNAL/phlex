name: CMake Build and Test
run-name: "${{ github.actor }} building and testing Phlex"

on:
  push:
    branches: [ main ]
  pull_request:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      compiler:
        description: 'Compiler to use (gcc or clang)'
        required: false
        default: ''
      sanitizer:
        description: 'Sanitizer to use (none, asan, or tsan)'
        required: false
        default: ''

permissions:
  contents: read
  pull-requests: read

env:
  BUILD_TYPE: Release

jobs:
  detect-build-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    outputs:
      triggered: ${{ steps.decision.outputs.triggered }}

    steps:
    - name: Check out source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: phlex-src

    - name: Detect act environment
      id: detect_act
      run: |
        if [ "${GITHUB_ACTOR}" = "nektos/act" ] || [ "${ACT:-}" = "true" ] || [ "${ACT:-}" = "1" ]; then
          echo "is_act=true" >> $GITHUB_OUTPUT
        else
          echo "is_act=false" >> $GITHUB_OUTPUT
        fi

    - name: Force execution when running under act
      id: act_force
      if: ${{ steps.detect_act.outputs.is_act == 'true' }}
      run: |
        echo "matched=true" >> "$GITHUB_OUTPUT"

    - name: Check for workflow_dispatch or issue_comment trigger
      id: check_manual_triggers
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'issue_comment'
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "triggered=true"
        elif echo "${{ github.event.comment.body }}" | grep -qE '^@phlexbot[[:space:]]+build\b'; then
          echo "triggered=true"
        else
          echo "triggered=false"
        fi > >(tee -a $GITHUB_OUTPUT)

    - name: Detect relevant changes
      id: filter
      if: ${{ steps.detect_act.outputs.is_act != 'true' && (github.event_name == 'push' || github.event_name == 'pull_request') }}
      uses: ./phlex-src/.github/actions/detect-relevant-changes
      with:
        repo-path: phlex-src
        base-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event.before }}
        head-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
        file-type: |
          cpp
          cmake

    - name: Set final decision
      id: decision
      run: |
        if [ "${{ steps.act_force.outputs.matched }}" = "true" ]; then
          echo "triggered=true"
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "issue_comment" ]; then
          echo "triggered=${{ steps.check_manual_triggers.outputs.triggered }}"
        elif [ "${{ github.event_name }}" = "push" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "triggered=${{ steps.filter.outputs.matched }}"
        else
          echo "triggered=false"
        fi > >(tee -a $GITHUB_OUTPUT)

  build:
    name: Build and Test (${{ matrix.compiler }}, ${{ matrix.sanitizer }})
    needs: detect-build-changes
    if: needs.detect-build-changes.outputs.triggered == 'true' && (github.event_name == 'workflow_dispatch' || github.event.comment.author_association == 'COLLABORATOR' || github.event.comment.author_association == 'OWNER') &&
      (github.event_name != 'push' && github.event_name != 'pull_request' ||
       matrix.compiler != 'clang' || matrix.sanitizer != 'none') &&
      (github.event_name != 'push' && github.event_name != 'pull_request' ||
       matrix.compiler != 'clang' || matrix.sanitizer != 'tsan')
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        sanitizer: [none, asan, tsan]
        exclude:
          - compiler: clang
            sanitizer: none
          - compiler: clang
            sanitizer: tsan

    container:
      image: ghcr.io/framework-r-d/phlex-ci:latest

    steps:
    - name: Get PR details for comment trigger
      if: github.event_name == 'issue_comment'
      id: pr
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
      with:
        script: |
          const pr = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          return {
            ref: pr.data.head.ref,
            sha: pr.data.head.sha
          };

    - name: Check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        path: phlex-src
        ref: ${{ github.event_name == 'issue_comment' && fromJSON(steps.pr.outputs.result).sha || github.ref }}

    - name: Setup build environment
      uses: Framework-R-D/phlex/.github/actions/setup-build-env@main

    - name: Announce CMake configuration
      run: echo "➡️ Configuring CMake..."

    - name: Configure CMake
      id: configure
      uses: Framework-R-D/phlex/.github/actions/configure-cmake@main
      with:
        build-type: ${{ env.BUILD_TYPE }}
        cpp-compiler: ${{ matrix.compiler == 'gcc' && 'g++' || 'clang++' }}
        extra-options: |
          ${{ matrix.sanitizer == 'asan' && '-DPHLEX_ENABLE_ASAN=ON' || '' }}
          ${{ matrix.sanitizer == 'tsan' && '-DPHLEX_ENABLE_TSAN=ON' || '' }}
      continue-on-error: true

    - name: Evaluate CMake configuration result
      if: always()
      run: |
        if [[ ${{ steps.configure.outcome }} == 'success' ]]; then
          echo "✅ CMake configuration succeeded."
        else
          echo "❌ CMake configuration failed."
          exit 1
        fi

    - name: Announce build
      run: echo "➡️ Building code..."

    - name: Build
      id: build
      uses: Framework-R-D/phlex/.github/actions/build-cmake@main
      continue-on-error: true

    - name: Evaluate build result
      if: always()
      run: |
        if [[ ${{ steps.build.outcome }} == 'success' ]]; then
          echo "✅ Build succeeded."
        else
          echo "❌ Build failed."
          exit 1
        fi

    - name: Run tests
      env:
        CICOLOR_FORCE: 1
      run: |
        . /entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build

        echo "➡️ Running tests..."
        echo "::group::Running ctest"
        if ctest --progress --output-on-failure -j $(nproc); then
          echo "::endgroup::"
          echo "✅ All tests passed."
        else
          echo "::endgroup::"
          echo "❌ Some tests failed."
          exit 1
        fi
