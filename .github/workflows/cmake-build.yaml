name: CMake Build and Test
run-name: "${{ github.actor }} building and testing Phlex"

on:
  push:
    branches: [ main ]
  pull_request:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      build-combinations:
        description: |
          A space- or comma-separated list of build combinations to run.
          Syntax examples:
          - `gcc/asan clang/tsan` (run only these two)
          - `all` (run all combinations)
          - `all -clang/none -clang/valgrind` (run all except specified)
          - `+clang/none +clang/valgrind` (run default matrix plus specified)
          Default (if empty): Run all except clang/none and clang/valgrind.
        required: false
        default: ''

permissions:
  contents: read
  pull-requests: read

env:
  BUILD_TYPE: Release

jobs:
  detect-build-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    outputs:
      triggered: ${{ steps.decision.outputs.triggered }}
      is_act: ${{ steps.detect_act.outputs.is_act }}

    steps:
    - name: Check out source code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        fetch-depth: 0
        path: phlex-src

    - name: Detect act environment
      id: detect_act
      uses: ./phlex-src/.github/actions/detect-act-env

    - name: Check for workflow_dispatch or issue_comment trigger
      id: check_manual_triggers
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'issue_comment'
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "triggered=true"
        elif echo "${{ github.event.comment.body }}" | grep -qE '^@phlexbot[[:space:]]+build\b'; then
          echo "triggered=true"
        else
          echo "triggered=false"
        fi > >(tee -a $GITHUB_OUTPUT)

    - name: Detect relevant changes
      id: filter
      if: ${{ steps.detect_act.outputs.is_act != 'true' && (github.event_name == 'push' || github.event_name == 'pull_request') }}
      uses: ./phlex-src/.github/actions/detect-relevant-changes
      with:
        repo-path: phlex-src
        base-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event.before }}
        head-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
        file-type: |
          cpp
          cmake

    - name: Set final decision
      id: decision
      run: |
        if [ "${{ steps.detect_act.outputs.is_act }}" = "true" ]; then
          echo "triggered=true"
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "issue_comment" ]; then
          echo "triggered=${{ steps.check_manual_triggers.outputs.triggered }}"
        elif [ "${{ github.event_name }}" = "push" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "triggered=${{ steps.filter.outputs.matched }}"
        else
          echo "triggered=false"
        fi > >(tee -a $GITHUB_OUTPUT)

  generate-matrix:
    name: Generate Build Matrix
    needs: detect-build-changes
    if: needs.detect-build-changes.outputs.triggered == 'true'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - id: generate
        env:
          USER_INPUT: ${{ github.event.inputs.build-combinations }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          all_combinations=(
            "gcc/none" "gcc/asan" "gcc/tsan" "gcc/valgrind"
            "clang/none" "clang/asan" "clang/tsan" "clang/valgrind"
          )
          default_excluded=( "clang/none" "clang/valgrind" )

          # Determine input string based on trigger
          input_str=""
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            input_str="$USER_INPUT"
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            input_str=$(echo "$COMMENT_BODY" | sed -n 's/^@phlexbot build //p')
          fi

          # Parse input string
          read -ra tokens <<< "${input_str//,/ }"

          final_combinations=()
          if [ ${#tokens[@]} -eq 0 ]; then
            # Default behavior for PR/push or empty manual trigger
            for combo in "${all_combinations[@]}"; do
              is_excluded=0
              for excluded_combo in "${default_excluded[@]}"; do
                if [ "$combo" == "$excluded_combo" ]; then
                  is_excluded=1
                  break
                fi
              done
              if [ $is_excluded -eq 0 ]; then
                final_combinations+=("$combo")
              fi
            done
          else
            # Manual trigger with specific combinations
            is_additive=0
            for token in "${tokens[@]}"; do
              if [ "$token" == "all" ] || [[ "$token" == +* ]] || [[ "$token" == -* ]]; then
                is_additive=1
                break
              fi
            done

            if [ $is_additive -eq 1 ]; then
              # Additive/Subtractive mode
              base_set=()
              if [[ " ${tokens[*]} " =~ " all " ]]; then
                base_set=("${all_combinations[@]}")
              else
                # Start with default set for additions
                for combo in "${all_combinations[@]}"; do
                  is_excluded=0
                  for excluded_combo in "${default_excluded[@]}"; do
                    if [ "$combo" == "$excluded_combo" ]; then
                      is_excluded=1
                      break
                    fi
                  done
                  if [ $is_excluded -eq 0 ]; then
                    base_set+=("$combo")
                  fi
                done
              fi

              additions=()
              removals=()
              for token in "${tokens[@]}"; do
                if [[ "$token" == -* ]]; then
                  removals+=("${token:1}")
                elif [[ "$token" == +* ]]; then
                  additions+=("${token:1}")
                fi
              done

              # Additions
              for combo in "${additions[@]}"; do
                base_set+=("$combo")
              done

              # Removals
              temp_set=()
              for combo in "${base_set[@]}"; do
                is_excluded=0
                for excluded_combo in "${removals[@]}"; do
                  if [ "$combo" == "$excluded_combo" ]; then
                    is_excluded=1
                    break
                  fi
                done
                if [ $is_excluded -eq 0 ]; then
                  temp_set+=("$combo")
                fi
              done
              final_combinations=("${temp_set[@]}")
            else
              # Explicit list mode
              final_combinations=("${tokens[@]}")
            fi
          fi

          # Generate JSON
          json="{\"include\":["
          first=true
          unique_combinations=($(echo "${final_combinations[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))
          for combo in "${unique_combinations[@]}"; do
            if [ "$first" = false ]; then
              json+=","
            fi
            first=false
            compiler=$(echo "$combo" | cut -d'/' -f1)
            sanitizer=$(echo "$combo" | cut -d'/' -f2)
            json+="{\"compiler\":\"$compiler\",\"sanitizer\":\"$sanitizer\"}"
          done
          json+="]}"
          echo "matrix=$json" >> $GITHUB_OUTPUT

  build:
    name: Build and Test (${{ matrix.compiler }}, ${{ matrix.sanitizer }})
    needs: [detect-build-changes, generate-matrix]
    if: |
      needs.detect-build-changes.outputs.triggered == 'true' &&
      (
        github.event_name != 'issue_comment' ||
        (github.event.comment.author_association == 'COLLABORATOR' || github.event.comment.author_association == 'OWNER')
      )
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.generate-matrix.outputs.matrix) }}

    container:
      image: ghcr.io/framework-r-d/phlex-ci:latest

    steps:
    - name: Get PR details for comment trigger
      if: github.event_name == 'issue_comment'
      id: pr
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
      with:
        script: |
          const pr = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          return {
            ref: pr.data.head.ref,
            sha: pr.data.head.sha
          };

    - name: Check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        path: phlex-src
        ref: ${{ github.event_name == 'issue_comment' && fromJSON(steps.pr.outputs.result).sha || github.ref }}

    - name: Setup build environment
      uses: Framework-R-D/phlex/.github/actions/setup-build-env@main

    - name: Announce CMake configuration
      run: echo "➡️ Configuring CMake..."

    - name: Configure CMake
      id: configure
      uses: Framework-R-D/phlex/.github/actions/configure-cmake@main
      with:
        build-type: ${{ env.BUILD_TYPE }}
        cpp-compiler: ${{ matrix.compiler == 'gcc' && 'g++' || 'clang++' }}
        extra-options: |
          ${{ matrix.sanitizer == 'asan' && '-DPHLEX_ENABLE_ASAN=ON' || '' }}
          ${{ matrix.sanitizer == 'tsan' && '-DPHLEX_ENABLE_TSAN=ON' || '' }}

    - name: Build
      id: build
      uses: Framework-R-D/phlex/.github/actions/build-cmake@main

    - name: Run tests
      if: matrix.sanitizer != 'valgrind'
      env:
        CICOLOR_FORCE: 1
      run: |
        . /entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build

        echo "➡️ Running tests..."
        echo "::group::Running ctest"
        if ctest --progress --output-on-failure -j $(nproc); then
          echo "::endgroup::"
          echo "✅ All tests passed."
        else
          echo "::endgroup::"
          echo "❌ Some tests failed."
          exit 1
        fi

    - name: Run Valgrind tests
      if: matrix.sanitizer == 'valgrind'
      env:
        CICOLOR_FORCE: 1
      run: |
        . /entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build

        echo "➡️ Running Valgrind tests..."
        echo "::group::Running ctest -T memcheck"
        if ctest -T memcheck; then
          echo "::endgroup::"
          echo "✅ Valgrind tests passed."
        else
          echo "::endgroup::"
          echo "⚠️ Valgrind tests failed, but the workflow will continue."
        fi

  build-skipped:
    name: Build and Test Skipped
    needs: detect-build-changes
    if: needs.detect-build-changes.outputs.triggered != 'true' && needs.detect-build-changes.outputs.is_act != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Report skipped build
        run: echo "No relevant changes detected, build and test skipped."
