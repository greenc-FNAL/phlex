name: CMake Build and Test
run-name: "${{ github.actor }} building and testing Phlex"

on:
  push:
    branches: [ main ]
  pull_request:
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

env:
  BUILD_TYPE: Release

jobs:
  detect-build-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    outputs:
      triggered: ${{ steps.decision.outputs.triggered }}

    steps:
    - name: Check out source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: phlex-src

    - name: Detect act environment
      id: detect_act
      run: |
        if [ "${GITHUB_ACTOR}" = "nektos/act" ] || [ "${ACT:-}" = "true" ] || [ "${ACT:-}" = "1" ]; then
          echo "is_act=true" >> $GITHUB_OUTPUT
        else
          echo "is_act=false" >> $GITHUB_OUTPUT
        fi

    - name: Force execution when running under act
      id: act_force
      if: ${{ steps.detect_act.outputs.is_act == 'true' }}
      run: |
        echo "matched=true" >> "$GITHUB_OUTPUT"

    - name: Check for workflow_dispatch or issue_comment trigger
      id: check_manual_triggers
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'issue_comment'
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "triggered=true"
        elif echo "${{ github.event.comment.body }}" | grep -qE '^@phlexbot[[:space:]]+build\b'; then
          echo "triggered=true"
        else
          echo "triggered=false"
        fi > >(tee -a $GITHUB_OUTPUT)

    - name: Detect relevant changes
      id: filter
      if: ${{ steps.detect_act.outputs.is_act != 'true' && (github.event_name == 'push' || github.event_name == 'pull_request') }}
      uses: ./phlex-src/.github/actions/detect-relevant-changes
      with:
        repo-path: phlex-src
        base-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event.before }}
        head-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
        file-type: |
          cpp
          cmake

    - name: Set final decision
      id: decision
      run: |
        if [ "${{ steps.act_force.outputs.matched }}" = "true" ]; then
          echo "triggered=true"
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "issue_comment" ]; then
          echo "triggered=${{ steps.check_manual_triggers.outputs.triggered }}"
        elif [ "${{ github.event_name }}" = "push" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "triggered=${{ steps.filter.outputs.matched }}"
        else
          echo "triggered=false"
        fi > >(tee -a $GITHUB_OUTPUT)

  build:
    needs: detect-build-changes
    if: needs.detect-build-changes.outputs.triggered == 'true' && (github.event_name == 'workflow_dispatch' || github.event.comment.author_association == 'COLLABORATOR' || github.event.comment.author_association == 'OWNER')
    runs-on: ubuntu-24.04

    container:
      image: ghcr.io/framework-r-d/phlex-ci:latest

    steps:
    - name: Get PR details for comment trigger
      if: github.event_name == 'issue_comment'
      id: pr
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
      with:
        script: |
          const pr = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          return {
            ref: pr.data.head.ref,
            sha: pr.data.head.sha
          };

    - name: Check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        path: phlex-src
        ref: ${{ github.event_name == 'issue_comment' && fromJSON(steps.pr.outputs.result).sha || github.ref }}

    - name: Setup build environment
      uses: Framework-R-D/phlex/.github/actions/setup-build-env@main

    - name: Configure CMake
      uses: Framework-R-D/phlex/.github/actions/configure-cmake@main
      with:
        build-type: ${{ env.BUILD_TYPE }}
        cpp-compiler: g++

    - name: Build
      uses: Framework-R-D/phlex/.github/actions/build-cmake@main

    - name: Test
      run: |
        . /entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build
        ctest -j $(nproc)
