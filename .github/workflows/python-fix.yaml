name: Python Fix
run-name: "${{ github.actor }} fixing Python code"

on:
  issue_comment:
    types:
      - created
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to apply fixes to"
        required: true

jobs:
  apply_fixes:
    runs-on: ubuntu-latest
    name: Apply fixes
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'issue_comment' && github.event.issue.pull_request && (github.event.comment.author_association == 'COLLABORATOR' || github.event.comment.author_association == 'OWNER') && contains(github.event.comment.body, '@phlexbot python-fix'))
    permissions:
      contents: write
      pull-requests: write
    container:
      image: ghcr.io/framework-r-d/phlex-ci:latest
    steps:
      - id: get_pr_info
        if: github.event_name == 'issue_comment'
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          REPO="${{ github.repository }}"
          gh api "repos/$REPO/pulls/$ISSUE_NUMBER" > pr.json
          echo "ref_name=$(jq -r .head.ref pr.json)" >> $GITHUB_OUTPUT
          echo "repo_name=$(jq -r .head.repo.full_name pr.json)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        if: github.event_name == 'issue_comment'
        with:
          path: phlex-src
          ref: ${{ steps.get_pr_info.outputs.ref_name }}
          repository: ${{ steps.get_pr_info.outputs.repo_name }}
          token: ${{ secrets.WORKFLOW_PAT }}

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        if: github.event_name == 'workflow_dispatch'
        with:
          path: phlex-src
          ref: ${{ github.event.inputs.branch }}
          token: ${{ secrets.WORKFLOW_PAT }}

      - name: Run ruff format and fix
        working-directory: phlex-src
        run: |
          . /entrypoint.sh
          echo "Fixing Python format with ruff"
          ruff format . || true
          echo "Fixing Python linter issues with ruff"
          ruff --fix . || true

      - uses: EndBug/add-and-commit@777a761e0f8293b7b051170404976d7cf10611cb # v9.1.4
        id: add_and_commit
        with:
          token: ${{ secrets.WORKFLOW_PAT }}
          cwd: phlex-src
          author_name: "github-actions[bot]"
          author_email: "41898282+github-actions[bot]@users.noreply.github.com"
          message: 'Committing Python linting fixes'

      - name: Formatting changes committed and pushed
        if: github.event_name == 'issue_comment' && steps.add_and_commit.outputs.committed == 'true' && steps.add_and_commit.outputs.pushed == 'true'
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
        with:
          message: |
            Python linting fixes pushed (commit ${{ steps.add_and_commit.outputs.commit_sha }})

      - name: No formatting changes to make
        if: github.event_name == 'issue_comment' && steps.add_and_commit.outputs.committed == 'false'
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
        with:
          message: |
            No Python linting fixes to make

      - name: Log commit SHA
        if: github.event_name == 'workflow_dispatch' && steps.add_and_commit.outputs.committed == 'true'
        run: echo "Changes committed: ${{ steps.add_and_commit.outputs.commit_sha }}"

      - name: Log no changes
        if: github.event_name == 'workflow_dispatch' && steps.add_and_commit.outputs.committed == 'false'
        run: echo "No changes to commit."
