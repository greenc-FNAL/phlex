name: CMake Format Check
run-name: "${{ github.actor }} running CMake format check"

permissions:
  contents: read
  pull-requests: read

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  detect-cmake-format-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    outputs:
      has_changes: ${{ steps.filter.outputs.matched }}
      changed_files: ${{ steps.filter.outputs.matched_files }}
      is_act: ${{ steps.detect_act.outputs.is_act }}

    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4.1.7
      with:
        fetch-depth: 0
        path: phlex-src

    - name: Detect act environment
      id: detect_act
      uses: ./phlex-src/.github/actions/detect-act-env

    - name: Detect CMake formatting changes
      id: filter
      uses: Framework-R-D/phlex/.github/actions/detect-relevant-changes@main
      with:
        repo-path: phlex-src
        base-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event.before }}
        head-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
        file-type: cmake

    - name: Report detection outcome
      run: |
        if [ "${{ steps.filter.outputs.matched }}" != "true" ]; then
          echo "::notice::No CMake-related changes detected; formatting check will be skipped."
        else
          echo "::group::CMake-related files"
          printf '%s\n' "${{ steps.filter.outputs.matched_files }}"
          echo "::endgroup::"
        fi

  cmake-format-check:
    needs: detect-cmake-format-changes
    if: ${{ (needs.detect-cmake-format-changes.outputs.has_changes == 'true') || (github.event_name == 'workflow_dispatch') || (needs.detect-cmake-format-changes.outputs.is_act == 'true') }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4.1.7
      with:
        path: phlex-src

    - name: Set up Python
      uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
      with:
        python-version: '3.x'

    - name: Install cmake-format
      run: pip install cmakelang

    - name: Check CMake formatting
      run: |
        echo "➡️ Checking CMake file formatting..."
        cd phlex-src

        cmake_files=$(find . -type f \( -name "CMakeLists.txt" -o -name "CMakeLists.txt.in" -o -name "*.cmake" -o -name "*.cmake.in" \) ! -path "*/build/*" ! -path "*/_deps/*")

        if [ -z "$cmake_files" ]; then
          echo "No CMake files found to check"
          exit 0
        fi

        echo "::group::Running cmake-format --check"
        format_errors=0
        for file in $cmake_files; do
          if ! cmake-format --check "$file"; then
            format_errors=$((format_errors + 1))
          fi
        done
        echo "::endgroup::"

        if [ $format_errors -gt 0 ]; then
          echo "❌ Found $format_errors file(s) with formatting issues."
          echo "::error::Run 'cmake-format -i <file>' locally or comment '@phlexbot format' on the PR to auto-fix."
          exit 1
        else
          echo "✅ All CMake files are properly formatted."
        fi

  cmake-format-check-skipped:
    needs: detect-cmake-format-changes
    if: ${{ (needs.detect-cmake-format-changes.outputs.has_changes != 'true') && (github.event_name != 'workflow_dispatch') && (needs.detect-cmake-format-changes.outputs.is_act != 'true') }}
    runs-on: ubuntu-latest

    steps:
    - name: No relevant CMake changes detected
      run: echo "No CMake-related changes detected; cmake-format check skipped."
