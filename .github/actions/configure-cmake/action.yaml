name: 'Configure CMake'
description: 'Configures CMake with preset detection and customizable options'

inputs:
  preset:
    description: 'CMake preset to use (e.g., coverage, default)'
    required: false
    default: 'default'
  source-path:
    description: 'Path where source code is checked out'
    required: false
    default: 'phlex-src'
  build-path:
    description: 'Path for build directory'
    required: false
    default: 'phlex-build'
  build-type:
    description: 'CMake build type (Release, Debug, etc.) [do not use with coverage presets]'
    required: false
    default: ''
  extra-options:
    description: 'Additional CMake configuration options'
    required: false
    default: ''
  enable-form:
    description: 'Enable FORM support'
    required: false
    default: 'ON'
  form-root-storage:
    description: 'Enable FORM root storage'
    required: false
    default: 'ON'
  generator:
    description: 'Specify CMake generator'
    required: false
    default: 'Ninja'
  cpp-compiler:
    description: 'The C++ compiler to use'
    required: false
    default: 'g++'

runs:
  using: 'composite'
  steps:
    - shell: bash
      run: |
        # Source the container entrypoint script
        . /entrypoint.sh
        cd "$GITHUB_WORKSPACE/$BUILD_PATH"
        SOURCE_DIR="$GITHUB_WORKSPACE/$SOURCE_PATH"
        echo "Configuring with CMake preset: $PRESET"

        # Base CMake options
        CMAKE_ARGS=(
          --preset="$PRESET" "$SOURCE_DIR"
          -G "$GENERATOR"
          -DCMAKE_CXX_COMPILER="$CPP_COMPILER"
          -DCMAKE_CXX_FLAGS="-fdiagnostics-color=always"
          -DPHLEX_USE_FORM="$ENABLE_FORM"
          -DFORM_USE_ROOT_STORAGE="$FORM_ROOT_STORAGE"
        )

        # Add build type if specified
        if [ -n "$BUILD_TYPE" ]; then
          CMAKE_ARGS+=(-DCMAKE_BUILD_TYPE="$BUILD_TYPE")
        fi

        # Add extra options
        if [ -n "$EXTRA_OPTIONS" ]; then
          CMAKE_ARGS+=($EXTRA_OPTIONS)
        fi

        # Run CMake
        cmake "${CMAKE_ARGS[@]}"

        echo "Source directory: $SOURCE_DIR"
        echo "Build directory: $(pwd)"
        echo "Generator: $GENERATOR"
        echo "C++ compiler: $CPP_COMPILER"
      env:
        SOURCE_PATH: ${{ inputs.source-path }}
        BUILD_PATH: ${{ inputs.build-path }}
        EXTRA_OPTIONS: ${{ inputs.extra-options }}
        ENABLE_FORM: ${{ inputs.enable-form }}
        FORM_ROOT_STORAGE: ${{ inputs.form-root-storage }}
        GENERATOR: ${{ inputs.generator }}
        CPP_COMPILER: ${{ inputs.cpp-compiler }}
        PRESET: ${{ inputs.preset }}
        BUILD_TYPE: ${{ inputs.build-type }}
        CMAKE_COLOR_DIAGNOSTICS: ON
